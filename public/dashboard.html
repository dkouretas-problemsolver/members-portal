<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ProblemSolver • Μέλη</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--brand:#FF6B00;--muted:#6b7280;--ok:#16a34a;--bg:#f6f7f9}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:#111}

    /* Top logo bar – πιο μαζεμένη */
    .topbar{padding:6px 0;border-bottom:1px solid #eee;background:#fff;position:sticky;top:0;z-index:20}
    .topbar .logo{display:flex;align-items:center;justify-content:center;gap:10px;font-weight:800}
    .topbar img{width:84px;height:84px;border-radius:12px}
    .subbar{display:flex;justify-content:flex-end;gap:8px;padding:6px 12px;border-top:1px solid #f2f2f2;background:#fff}

    .btn{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:600;height:38px;line-height:22px}
    .btn.brand{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.brand:hover{filter:brightness(.98)}

    .container{max-width:1100px;margin:12px auto 18px;padding:0 12px}  /* μικρότερο top margin */
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .card{background:#fff;border:1px solid #eee;border-radius:14px;padding:12px} /* πιο σφιχτά */
    .kpi{padding:14px}
    .kpi h4{margin:0 0 6px 0;font-size:13px;color:var(--muted);font-weight:600}
    .kpi .value{min-height:26px;font-size:21px;font-weight:700;letter-spacing:0.2px}
    .section-title{font-weight:700;margin:6px 0 10px 0;color:#111}

    table{width:100%;border-collapse:collapse}
    th,td{padding:9px 8px;border-bottom:1px solid #eee;font-size:14px}
    th{color:#374151;text-align:left}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#f3f4f6;color:#374151;font-size:12px;font-weight:600}
    .pill.ok{background:#e8f7ec;color:#067647}
    .pill.warn{background:#fff4e5;color:#92400e}

    /* Account + editable billing */
    .account{display:grid;grid-template-columns:120px 1fr;row-gap:8px;column-gap:8px}
    .account .label{color:#6b7280}
    .account-section{margin-top:22px;padding-top:14px;border-top:3px solid rgba(255,107,0,.28)}
    .form-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .input{width:100%;padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px}

    .inv-only{display:none}

    /* Answers clamp */
    .answer-text{display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
    .answer-text.open{-webkit-line-clamp:unset}
    .show-more{border:none;background:none;color:#FF6B00;cursor:pointer;font-weight:600;padding:0;margin-top:4px}
  </style>

  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>
<body>

  <!-- Logo centered -->
  <div class="topbar">
    <div class="logo">
      <img src="https://raw.githubusercontent.com/dkouretas-problemsolver/members-portal/main/public/brandmark-design-1080x1080.png" alt="ProblemSolver">
      <div>ProblemSolver • Μέλη</div>
    </div>
    <div class="subbar">
      <button id="btnSignOut" class="btn">Αποσύνδεση</button>
    </div>
  </div>

  <div class="container">
    <div class="grid">
      <!-- KPIs -->
      <div class="card kpi" style="grid-column: span 3;">
        <h4>Σύνολο Credits</h4><div id="totalCredits" class="value">—</div>
      </div>
      <div class="card kpi" style="grid-column: span 3;">
        <h4>Δεσμευμένα</h4><div id="reservedCredits" class="value">—</div>
      </div>
      <div class="card kpi" style="grid-column: span 3;">
        <h4>Διαθέσιμα</h4><div id="availableCredits" class="value">—</div>
      </div>
      <div class="card kpi" style="grid-column: span 3;">
        <h4>Επόμενη Λήξη</h4><div id="nextExpiry" class="value">—</div>
      </div>

      <!-- ΑΡΙΣΤΕΡΑ: Λογαριασμός + Στοιχεία Πελάτη -->
      <div class="card" style="grid-column: span 7;">
        <div class="section-title">Λογαριασμός</div>
        <div class="account">
          <div class="label">Όνομα:</div> <div id="accName">—</div>
          <div class="label">Email:</div> <div id="accEmail" class="mono">—</div>
          <div class="label">User:</div>  <div id="accUser" class="mono">—</div>
        </div>

        <div class="account-section">
          <div class="section-title" style="margin:0 0 8px">Στοιχεία Πελάτη (Επεξεργάσιμα)</div>

          <div class="form-grid">
            <div style="grid-column:span 4">
              <div class="muted">Τύπος</div>
              <select id="bill_doc_type" class="input">
                <option value="receipt">Απόδειξη</option>
                <option value="invoice">Τιμολόγιο</option>
              </select>
            </div>
            <div style="grid-column:span 8">
              <div class="muted">Ονοματεπώνυμο / Επωνυμία</div>
              <input id="bill_name" class="input" placeholder="Πλήρες όνομα ή επωνυμία">
            </div>

            <!-- Invoice-only -->
            <div class="inv-only" style="grid-column:span 4">
              <div class="muted">ΑΦΜ</div>
              <input id="bill_vat" class="input" placeholder="ΑΦΜ">
            </div>
            <div class="inv-only" style="grid-column:span 4">
              <div class="muted">ΔΟΥ</div>
              <input id="bill_tax_office" class="input" placeholder="ΔΟΥ">
            </div>
            <div class="inv-only" style="grid-column:span 12">
              <div class="muted">Διεύθυνση</div>
              <input id="bill_address" class="input" placeholder="Οδός & αριθμός">
            </div>
            <div class="inv-only" style="grid-column:span 6">
              <div class="muted">Πόλη</div>
              <input id="bill_city" class="input" placeholder="Πόλη">
            </div>
            <div class="inv-only" style="grid-column:span 3">
              <div class="muted">Τ.Κ.</div>
              <input id="bill_zip" class="input" placeholder="Τ.Κ.">
            </div>
            <div class="inv-only" style="grid-column:span 3">
              <div class="muted">Χώρα</div>
              <input id="bill_country" class="input" placeholder="Χώρα">
            </div>

            <!-- Common -->
            <div style="grid-column:span 6">
              <div class="muted">Τηλέφωνο</div>
              <input id="bill_phone" class="input" placeholder="τηλέφωνο">
            </div>
            <div style="grid-column:span 6">
              <div class="muted">Email τιμολόγησης</div>
              <input id="bill_email" class="input" placeholder="email για παραστατικό">
            </div>
          </div>

          <div class="muted" id="bill_msg" style="margin-top:8px"></div>
          <div style="display:flex;justify-content:flex-end;margin-top:8px">
            <button id="btnSaveBilling" class="btn brand">Αποθήκευση</button>
          </div>
        </div>
      </div>

      <!-- ΔΕΞΙΑ: Ερωτήσεις + Κρατήσεις στο ίδιο card για να μη μένει άδειο -->
      <div class="card" style="grid-column: span 5;">
        <div class="section-title">Ιστορικό Ερωτήσεων</div>
        <table id="tblQuestions">
          <thead><tr><th>Ημερομηνία</th><th>Θέμα/Ερώτηση</th><th>Status</th></tr></thead>
        </table>
        <table>
          <tbody id="tbodyQuestions"><tr><td class="muted" colspan="3">—</td></tr></tbody>
        </table>

        <div class="section-title" style="margin-top:12px">Κρατήσεις (Active)</div>
        <table id="tblRes">
          <thead><tr><th>Ημερομηνία</th><th>Ποσό</th><th>Κατάσταση</th><th>Λήξη</th></tr></thead>
          <tbody id="tbodyRes"><tr><td class="muted" colspan="4">—</td></tr></tbody>
        </table>
      </div>

      <!-- Απαντήσεις: χωρίς Status + clamp 3 γραμμές — πιο κοντά (πάνω margin μικρό) -->
      <div class="card" style="grid-column: span 12; margin-top:4px">
        <div class="section-title">Απαντήσεις</div>
        <table id="tblAnswers">
          <thead><tr><th>Ημερομηνία</th><th>Απάντηση / Πρόχειρο</th></tr></thead>
          <tbody id="tbodyAnswers"><tr><td class="muted" colspan="2">—</td></tr></tbody>
        </table>
      </div>
    </div>

    <p class="muted" style="margin:14px 4px;">© ProblemSolver.gr</p>
  </div>

  <script>
    /* === SUPABASE CONFIG === */
    const SUPABASE_URL = 'https://sctqieecpfsaszcuqcrv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjdHFpZWVjcGZzYXN6Y3VxY3J2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxODI5MjYsImV4cCI6MjA3NDc1ODkyNn0.swR5_WutqIlCvpH4s-2LEYgrH-UAp0op2sfKQeVWQOk';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{persistSession:true}, db:{schema:'app'} });

    const $ = (s)=>document.querySelector(s);
    const fmt = iso => { if(!iso) return '—'; const d=new Date(iso); return isNaN(d)?'—':d.toLocaleString('el-GR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}); };

    async function requireUser(){ const {data:{user}}=await supabase.auth.getUser(); if(!user){location.href='/login.html';return null;} return user; }

    /* ===== KPIs ===== */
    async function loadBalances(){
      let total=0,reserved=0,nextExpiry=null;
      try{
        const { data, error } = await supabase.from('credit_balances').select('balance').maybeSingle();
        if(error) throw error; total = (data?.balance ?? 0)|0;
      }catch(e){ console.error('credit_balances', e); }
      try{
        const { data, error } = await supabase.from('credit_reservations')
          .select('amount,credits_reserved,status,expires_at,created_at').eq('status','active');
        if(error) throw error;
        const now=new Date(); const active=(data||[]).filter(r=>r.status==='active' && (!r.expires_at || new Date(r.expires_at)>now));
        reserved = active.reduce((s,r)=>s+((r.credits_reserved ?? r.amount ?? 0)|0),0);
        active.forEach(r=>{ if(r.expires_at){ const d=new Date(r.expires_at); if(!nextExpiry||d<nextExpiry) nextExpiry=d; }});
      }catch(e){ console.warn('credit_reservations', e); }
      $('#totalCredits').textContent = total;
      $('#reservedCredits').textContent = reserved;
      $('#availableCredits').textContent = Math.max(0,total-reserved);
      $('#nextExpiry').textContent = nextExpiry ? nextExpiry.toLocaleDateString('el-GR') : '—';
    }

    /* ===== Q&A ===== */
    async function fetchMyQaAnswers(user){
      const { data, error } = await supabase.from('qa_answers')
        .select('id,created_at,updated_at,email,status,question,answer,agent_draft,user_id')
        .order('created_at',{ascending:false}).limit(200);
      if(error) throw error;
      return (data||[]).filter(r => (r.user_id && r.user_id===user.id) || (r.email && r.email===user.email));
    }
    async function loadQuestions(user){
      try{
        const rows = await fetchMyQaAnswers(user);
        const list = rows.filter(r => r.question && r.question.trim().length);
        const tb = $('#tbodyQuestions'); tb.innerHTML='';
        if(!list.length){ tb.innerHTML='<tr><td class="muted" colspan="3">—</td></tr>'; return; }
        for(const q of list){
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${fmt(q.created_at)}</td><td>${q.question}</td><td><span class="pill">${q.status||'—'}</span></td>`;
          tb.appendChild(tr);
        }
      }catch(e){ console.error('loadQuestions',e); $('#tbodyQuestions').innerHTML='<tr><td class="muted" colspan="3">—</td></tr>'; }
    }
    async function loadAnswers(user){
      try{
        const rows = await fetchMyQaAnswers(user);
        const list = rows.filter(r => (r.answer && r.answer.trim().length) || (r.agent_draft && r.agent_draft.trim().length));
        const tb = $('#tbodyAnswers'); tb.innerHTML='';
        if(!list.length){ tb.innerHTML='<tr><td class="muted" colspan="2">—</td></tr>'; return; }
        for(const a of list){
          const txt=(a.answer && a.answer.trim().length)?a.answer:(a.agent_draft||'—');
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td>${fmt(a.updated_at||a.created_at)}</td>
            <td>
              <div class="answer-text">${txt}</div>
              <button class="show-more">Περισσότερα</button>
            </td>`;
          tb.appendChild(tr);
        }
      }catch(e){ console.error('loadAnswers',e); $('#tbodyAnswers').innerHTML='<tr><td class="muted" colspan="2">—</td></tr>'; }
    }
    document.addEventListener('click',(e)=>{
      if(e.target && e.target.classList.contains('show-more')){
        const box = e.target.previousElementSibling;
        const open = box.classList.toggle('open');
        e.target.textContent = open ? 'Λιγότερα' : 'Περισσότερα';
      }
    });

    /* ===== Reservations ===== */
    async function loadReservations(){
      try{
        const { data, error } = await supabase.from('credit_reservations')
          .select('amount,credits_reserved,status,created_at,expires_at')
          .eq('status','active').order('created_at',{ascending:false}).limit(50);
        if(error) throw error;
        const tb=$('#tbodyRes'); tb.innerHTML='';
        if(!data?.length){ tb.innerHTML='<tr><td class="muted" colspan="4">—</td></tr>'; return; }
        for(const r of data){
          const amt=(r.credits_reserved ?? r.amount ?? 0);
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${fmt(r.created_at)}</td><td>${amt}</td><td><span class="pill ${r.status==='active'?'ok':'warn'}">${r.status}</span></td><td>${r.expires_at?fmt(r.expires_at):'—'}</td>`;
          tb.appendChild(tr);
        }
      }catch(e){ console.warn('loadReservations',e); $('#tbodyRes').innerHTML='<tr><td class="muted" colspan="4">—</td></tr>'; }
    }

    /* ===== Billing ===== */
    function toggleInvoiceFields(){
      const isInv = $('#bill_doc_type').value==='invoice';
      document.querySelectorAll('.inv-only').forEach(el=>el.style.display = isInv?'block':'none');
    }
    async function loadBilling(user){
      try{
        const { data, error } = await supabase.from('user_billing')
          .select('name,vat,tax_office,email,address,zip,city,country,phone,doc_type')
          .eq('user_id', user.id).maybeSingle();
        if(error) throw error;
        const v=data||{};
        $('#bill_name').value = v.name||'';
        $('#bill_vat').value = v.vat||'';
        $('#bill_tax_office').value = v.tax_office||'';
        $('#bill_email').value = v.email || user.email || '';
        $('#bill_address').value = v.address||'';
        $('#bill_zip').value = v.zip||'';
        $('#bill_city').value = v.city||'';
        $('#bill_country').value = v.country||'';
        $('#bill_phone').value = v.phone||'';
        $('#bill_doc_type').value = v.doc_type || 'receipt';
        toggleInvoiceFields();
      }catch(e){ console.warn('loadBilling', e); }
    }
    async function saveBilling(user){
      const rec = {
        user_id: user.id,
        name: $('#bill_name').value.trim()||null,
        vat: $('#bill_vat').value.trim()||null,
        tax_office: $('#bill_tax_office').value.trim()||null,
        email: $('#bill_email').value.trim()||user.email,
        address: $('#bill_address').value.trim()||null,
        zip: $('#bill_zip').value.trim()||null,
        city: $('#bill_city').value.trim()||null,
        country: $('#bill_country').value.trim()||null,
        phone: $('#bill_phone').value.trim()||null,
        doc_type: $('#bill_doc_type').value||'receipt',
        updated_at: new Date().toISOString()
      };
      try{
        const { error } = await supabase.from('user_billing').upsert(rec,{ onConflict:'user_id' });
        if(error) throw error;
        $('#bill_msg').textContent='Αποθηκεύτηκαν.';
        setTimeout(()=>$('#bill_msg').textContent='',2000);
      }catch(e){ $('#bill_msg').textContent='Σφάλμα: '+(e.message||e); }
    }

    /* ===== Boot & Events ===== */
    async function Boot(){
      const user = await requireUser(); if(!user) return;
      $('#accEmail').textContent = user.email || '—';
      $('#accUser').textContent  = user.id || '—';
      $('#accName').textContent  = user.user_metadata?.name || '—';

      await loadBilling(user);
      await loadBalances();
      await loadQuestions(user);
      await loadReservations();
      await loadAnswers(user);
    }

    document.addEventListener('change',(e)=>{ if(e.target && e.target.id==='bill_doc_type') toggleInvoiceFields(); });
    document.getElementById('btnSaveBilling').addEventListener('click', async ()=>{ const u = await requireUser(); if(u) saveBilling(u); });
    document.getElementById('btnSignOut').addEventListener('click', async ()=>{ await supabase.auth.signOut(); location.href='/login.html'; });

    Boot();
  </script>
</body>
</html>
