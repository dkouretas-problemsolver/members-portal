<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ProblemSolver â€¢ Dashboard</title>
  <style>
    :root { --brand:#FF6B00; --bg:#f7f7f8; --ink:#111; --muted:#666; --card:#fff; --ok:#0a7; --warn:#b50; }
    html,body { margin:0; padding:0; background:var(--bg); color:var(--ink); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { max-width:980px; margin:40px auto; padding:0 16px; }
    .header { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; }
    .brand { font-weight:800; font-size:18px; letter-spacing:.2px; display:flex; align-items:center; gap:10px; }
    .brand-badge { width:10px; height:10px; border-radius:50%; background:var(--brand); }
    .actions { display:flex; gap:8px; }
    button { appearance:none; border:0; border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer; }
    .btn { background:var(--brand); color:#fff; box-shadow:0 6px 18px rgba(255,107,0,.25); }
    .btn:disabled { opacity:.55; cursor:not-allowed; }
    .card { background:var(--card); border-radius:16px; padding:20px; box-shadow:0 6px 24px rgba(0,0,0,.06); }
    .grid { display:grid; grid-template-columns:repeat(3,1fr); gap:16px; }
    .stat { padding:18px; border:1px solid #eee; border-radius:14px; }
    .stat h3 { margin:0 0 6px 0; font-size:13px; color:var(--muted); font-weight:600; text-transform:uppercase; letter-spacing:.4px; }
    .stat .val { font-size:34px; font-weight:800; line-height:1.05; }
    .hint { margin-top:10px; color:var(--muted); font-size:13px; }
    .ok { color:var(--ok); }
    .warn { color:var(--warn); }
    .error { background:#fff3f3; color:#b00020; padding:10px 12px; border-radius:12px; border:1px solid #ffd6d6; margin-top:14px; display:none; }
    .section { margin-top:22px; }
    .section h2 { margin:0 0 10px 0; font-size:16px; }
    table { width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden; }
    th, td { padding:10px 12px; border-bottom:1px solid #eee; font-size:14px; }
    th { text-align:left; background:#fafafa; color:#444; }
    tr:last-child td { border-bottom:0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px; color:#333; }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; background:#f2f2f2; font-size:12px; }
    .pill.active { background:#eafff5; color:#027a48; }
    .pill.expired { background:#fff3f3; color:#b00020; }
    @media (max-width:720px){ .grid{grid-template-columns:1fr;} th:nth-child(2),td:nth-child(2){display:none;} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="brand"><span class="brand-badge"></span> ProblemSolver â€¢ Dashboard</div>
      <div class="actions">
        <button id="refresh-btn" class="btn">Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·</button>
      </div>
    </div>

    <div class="card">
      <div class="grid">
        <div class="stat">
          <h3>Î£Î¥ÎÎŸÎ›ÎŸ CREDITS</h3>
          <div id="credits-total" class="val">â€”</div>
          <div class="hint">Î‘Ï€ÏŒ Ï„Î¿ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿ Ï„Î¿Ï… Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï ÏƒÎ¿Ï….</div>
        </div>
        <div class="stat">
          <h3>Î”Î•Î£ÎœÎ•Î¥ÎœÎ•ÎÎ‘</h3>
          <div id="credits-reserved" class="val">â€”</div>
          <div id="next-exp" class="hint">Î•Ï€ÏŒÎ¼. Î»Î®Î¾Î·: â€”</div>
        </div>
        <div class="stat">
          <h3>Î”Î™Î‘Î˜Î•Î£Î™ÎœÎ‘</h3>
          <div id="credits-available" class="val">â€”</div>
          <div class="hint">= Î£ÏÎ½Î¿Î»Î¿ âˆ’ Î”ÎµÏƒÎ¼ÎµÏ…Î¼Î­Î½Î±</div>
        </div>
      </div>

      <div id="error-box" class="error"></div>
    </div>

    <div class="section">
      <h2>Î•Î½ÎµÏÎ³Î­Ï‚ Î´ÎµÏƒÎ¼ÎµÏÏƒÎµÎ¹Ï‚</h2>
      <div class="card">
        <table id="tbl-res">
          <thead>
            <tr>
              <th>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</th>
              <th>Question ID</th>
              <th>Î Î¿ÏƒÏŒ</th>
              <th>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th>
              <th>Î›Î®Î¾Î·</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="5" style="text-align:center;color:#777;">â€”</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ====== SCRIPT ====== -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    // Î¤Î‘ Î”Î™ÎšÎ‘ Î£ÎŸÎ¥ Î£Î¤ÎŸÎ™Î§Î•Î™Î‘
    const SUPABASE_URL  = 'https://sctqieecpfsaszcuqcrv.supabase.co'
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjdHFpZWVjcGZzYXN6Y3VxY3J2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxODI5MjYsImV4cCI6MjA3NDc1ODkyNn0.swR5_WutqIlCvpH4s-2LEYgrH-UAp0op2sfKQeVWQOk'

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON)
    const $ = (id) => document.getElementById(id)
    const btn = $('refresh-btn')
    const boxErr = $('error-box')

    function showError(msg){ boxErr.textContent = msg || 'ÎšÎ¬Ï„Î¹ Ï€Î®Î³Îµ ÏƒÏ„ÏÎ±Î²Î¬.'; boxErr.style.display='block' }
    function clearError(){ boxErr.textContent=''; boxErr.style.display='none' }
    function fmtTs(ts){ if(!ts) return 'â€”'; try{ return new Date(ts).toLocaleString('el-GR',{hour12:false}) } catch{ return String(ts) } }

    async function ensureSession(){
      const { data: { session } } = await supabase.auth.getSession()
      return session || null
    }

    async function fetchSummary(){
      const { data, error } = await supabase.rpc('get_user_credits_summary') // public wrapper
      if (error) throw error
      const row = Array.isArray(data) ? data[0] : data
      const total     = row?.total ?? 0
      const reserved  = row?.reserved ?? 0
      const available = row?.available ?? 0
      const nextExp   = row?.next_expiration ?? null

      $('credits-total').textContent     = total
      $('credits-reserved').textContent  = reserved
      $('credits-available').textContent = available
      $('next-exp').textContent          = `Î•Ï€ÏŒÎ¼. Î»Î®Î¾Î·: ${fmtTs(nextExp)}`
      $('credits-available').classList.toggle('warn', available <= 0)
      $('credits-available').classList.toggle('ok',   available > 0)
    }

    // ğŸ”§ Î Î¡ÎŸÎ£ÎŸÎ§Î—: Î¶Î·Ï„Î¬Î¼Îµ Î±Ï€ÏŒ schema 'app' (ÏŒÏ‡Î¹ public)
    async function fetchReservations(session){
      const tbody = document.querySelector('#tbl-res tbody')
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#777;">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·â€¦</td></tr>`

      const userId = session?.user?.id
      if (!userId){
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#777;">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎµÎ½ÎµÏÎ³ÏŒ login.</td></tr>`
        return
      }

      const { data, error } = await supabase
        .schema('app')
        .from('credit_reservations')
        .select('question_id, amount, status, expires_at, created_at')
        .eq('user_id', userId)
        .order('created_at', { ascending: false })
        .limit(25)

      if (error){
        console.error(error)
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#b00020;">Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚.</td></tr>`
        return
      }

      if (!data || data.length === 0){
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#777;">ÎšÎ±Î¼Î¯Î± ÎºÏÎ¬Ï„Î·ÏƒÎ·.</td></tr>`
        return
      }

      const rows = data.map(r => {
        const pillCls = r.status === 'active' ? 'pill active' : 'pill expired'
        return `<tr>
          <td>${fmtTs(r.created_at)}</td>
          <td class="mono">${r.question_id || 'â€”'}</td>
          <td>${r.amount ?? 0}</td>
          <td><span class="${pillCls}">${r.status}</span></td>
          <td>${fmtTs(r.expires_at)}</td>
        </tr>`
      }).join('')

      tbody.innerHTML = rows
    }

    async function refreshAll(){
      clearError()
      btn.disabled = true
      try {
        const session = await ensureSession()
        if(!session){ showError('Î”ÎµÎ½ Î­Ï‡ÎµÎ¹Ï‚ ÏƒÏ…Î½Î´ÎµÎ¸ÎµÎ¯. ÎšÎ¬Î½Îµ login ÎºÎ±Î¹ Î¾Î±Î½Î±Î´Î¿ÎºÎ¯Î¼Î±ÏƒÎµ.'); return }
        await fetchSummary()
        await fetchReservations(session)
      } catch (e) {
        console.error(e); showError(e?.message || 'Î£Ï†Î¬Î»Î¼Î±.')
      } finally {
        btn.disabled = false
      }
    }

    btn.addEventListener('click', refreshAll)
    window.addEventListener('DOMContentLoaded', refreshAll)
  </script>
</body>
</html>
