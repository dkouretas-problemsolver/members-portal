<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ProblemSolver • Dashboard</title>
  <link rel="icon" href="/brandmark-design-1080x1080.png">
  <style>
    :root{--brand:#FF6B00;--muted:#6b7280;--ok:#16a34a;--bg:#f6f7f9}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:#111}
    header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.06);position:sticky;top:0;z-index:10}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand .dot{width:12px;height:12px;background:var(--brand);border-radius:50%}
    .actions{display:flex;gap:8px}
    button{appearance:none;border:1px solid rgba(0,0,0,.08);background:#fff;border-radius:10px;padding:9px 12px;cursor:pointer}
    button.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    main{max-width:1100px;margin:24px auto;padding:0 16px}
    .grid{display:grid;gap:14px}
    .grid.cards{grid-template-columns:repeat(4,1fr)}
    .card{background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:14px;padding:16px}
    .kpi{display:flex;flex-direction:column;gap:6px}
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .value{font-size:26px;font-weight:800}
    .kpi .hint{font-size:12px;color:var(--muted)}
    .stack{display:grid;gap:14px;grid-template-columns:2fr 1fr}
    h2{margin:0 0 10px 0;font-size:16px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid #eee;font-size:14px;text-align:left}
    th{font-weight:600;color:#444;background:#fafafa}
    .pill{font-size:12px;padding:3px 8px;border-radius:100px;border:1px solid #eee}
    .pill.ok{border-color:#c9efd5;background:#ecfdf5;color:#047857}
    .pill.warn{border-color:#ffe1ba;background:#fff7ed;color:#b45309}
    .pill.mute{border-color:#e5e7eb;background:#f9fafb;color:#6b7280}
    .muted{color:var(--muted)}
    .row{display:flex;gap:14px;align-items:center}
    .spinner{display:none}
    .spinner.show{display:inline-block}
    .empty{padding:16px;color:var(--muted);font-size:14px}
    a.link{color:#111;text-decoration:underline}
    .foot{margin-top:28px;color:var(--muted);font-size:12px}
    @media(max-width:1000px){.stack{grid-template-columns:1fr}.grid.cards{grid-template-columns:1fr 1fr}}
    @media(max-width:640px){.grid.cards{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header>
  <div class="brand"><span class="dot"></span>ProblemSolver • Μέλη</div>
  <div class="actions">
    <button id="btnRefresh" title="Ανανέωση">Ανανέωση <span id="spin" class="spinner">⏳</span></button>
    <button id="btnLogout">Αποσύνδεση</button>
  </div>
</header>

<main>
  <div class="grid cards">
    <div class="card kpi">
      <div class="label">Σύνολο Credits</div>
      <div id="kpiTotal" class="value">—</div>
      <div id="kpiTotalHint" class="hint">&nbsp;</div>
    </div>
    <div class="card kpi">
      <div class="label">Δεσμευμένα</div>
      <div id="kpiReserved" class="value">—</div>
      <div id="kpiReservedHint" class="hint">&nbsp;</div>
    </div>
    <div class="card kpi">
      <div class="label">Διαθέσιμα</div>
      <div id="kpiAvailable" class="value">—</div>
      <div id="kpiAvailableHint" class="hint">&nbsp;</div>
    </div>
    <div class="card kpi">
      <div class="label">Επόμενη Λήξη</div>
      <div id="kpiExpiry" class="value">—</div>
      <div id="kpiExpiryHint" class="hint">&nbsp;</div>
    </div>
  </div>

  <div class="stack" style="margin-top:14px">
    <section class="card">
      <h2>Ιστορικό Ερωτήσεων</h2>
      <div id="questionsWrap">
        <table id="tblQuestions">
          <thead>
          <tr><th>Ημερομηνία</th><th>Θέμα</th><th>Status</th><th>Credits</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <aside class="card">
      <h2>Λογαριασμός</h2>
      <div class="row"><strong>Όνομα:</strong> <span id="uName" class="muted">—</span></div>
      <div class="row"><strong>Email:</strong> <span id="uEmail" class="muted">—</span></div>
      <div class="row"><strong>User ID:</strong> <span id="uId" class="muted">—</span></div>
      <hr style="margin:14px 0;border:none;border-top:1px solid #eee">
      <h2>Κρατήσεις (Active)</h2>
      <div id="reservationsWrap">
        <table id="tblRes">
          <thead>
            <tr><th>Ημερομηνία</th><th>Ποσό</th><th>Κατάσταση</th><th>Λήξη</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </aside>
  </div>

  <section class="card" style="margin-top:14px">
    <h2>Απαντήσεις</h2>
    <div id="answersWrap">
      <table id="tblAnswers">
        <thead>
        <tr><th>Ημερομηνία</th><th>Θέμα</th><th>Status</th><th>Link</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <div class="foot">© ProblemSolver.gr • Αν κάτι δεν φορτώνει, πάτα «Ανανέωση» ή κάνε νέα είσοδο.</div>
</main>

<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
  // ========= 1) SUPABASE =========
  const SUPABASE_URL = "https://sctqieecpfsaszcuqcrv.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjdHFpZWVjcGZzYXN6Y3VxY3J2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxODI5MjYsImV4cCI6MjA3NDc1ODkyNn0.swR5_WutqIlCvpH4s-2LEYgrH-UAp0op2sfKQeVWQOk";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
  });

  // ========= 2) HELPERS =========
  const $ = (sel) => document.querySelector(sel);
  const fmtDate = (v) => v ? new Date(v).toLocaleString('el-GR') : "—";
  const safe = (x) => (x ?? "—");
  function setSpin(on){ $("#spin").classList.toggle("show", !!on); }

  async function mustUser() {
    const { data: { user } } = await sb.auth.getUser();
    if (!user) { location.href = "/login.html"; return null; }
    return user;
  }

  async function safeSelect(table, cols, { match=null, orderCol=null, asc=false, limit=null } = {}) {
    let q = sb.from(table).select(cols);
    if (match) Object.entries(match).forEach(([k,v])=>{ q = q.eq(k, v); });
    if (orderCol) q = q.order(orderCol, { ascending: !!asc });
    if (limit) q = q.limit(limit);
    const { data, error } = await q;
    if (error) throw error;
    return data || [];
  }

  // ========= 3) LOAD =========
  async function loadAll() {
    setSpin(true);
    try {
      const user = await mustUser();
      if (!user) return;

      $("#uId").textContent = user.id;
      $("#uEmail").textContent = user.email || "—";
      $("#uName").textContent = user.user_metadata?.full_name || user.user_metadata?.name || "—";

      // Total credits
      let total = 0;
      try {
        const bal = await safeSelect('app.credit_balances', 'balance', { match: { user_id: user.id } });
        total = Number(bal?.[0]?.balance || 0);
      } catch(e) {
        const bal = await safeSelect('credit_balances', 'balance', { match: { user_id: user.id } });
        total = Number(bal?.[0]?.balance || 0);
      }

      // Reservations (active & not expired)
      let reserved = 0, nextExpiry = null;
      const nowISO = new Date().toISOString();

      async function fetchRes(match){
        const cols = 'amount,credits_reserved,status,created_at,expires_at';
        return await safeSelect('app.credit_reservations', cols, { match, orderCol: 'created_at', asc:false, limit: 200 });
      }

      let resRows = [];
      try { if (user.email) resRows = await fetchRes({ email: user.email }); } catch(e) {}
      if (!resRows.length) {
        try { resRows = await fetchRes({ user_id: user.id }); } catch(e) {}
      }

      resRows.forEach(r=>{
        const ok = (r.status === 'active') && (!r.expires_at || r.expires_at > nowISO);
        if (ok) {
          const amt = Number(r.credits_reserved ?? r.amount ?? 0);
          reserved += amt;
          if (r.expires_at) {
            const dt = new Date(r.expires_at);
            if (!nextExpiry || dt < nextExpiry) nextExpiry = dt;
          }
        }
      });

      const available = Math.max(0, (total||0) - (reserved||0));

      $("#kpiTotal").textContent = String(total);
      $("#kpiReserved").textContent = String(reserved);
      $("#kpiAvailable").textContent = String(available);
      $("#kpiExpiry").textContent = nextExpiry ? nextExpiry.toLocaleDateString('el-GR') : "—";
      $("#kpiReservedHint").textContent = reserved>0 ? "Υπάρχουν ενεργές κρατήσεις" : "Καμία ενεργή κράτηση";
      $("#kpiAvailableHint").textContent = "Υπολογισμός: σύνολο - δεσμευμένα";
      $("#kpiTotalHint").textContent = "";
      $("#kpiExpiryHint").textContent = nextExpiry ? "Κοντινότερη λήξη κράτησης" : "—";

      // Reservations table (active only)
      const tbodyRes = $("#tblRes tbody"); tbodyRes.innerHTML = "";
      const activeRows = resRows.filter(r => r.status==='active' && (!r.expires_at || r.expires_at > nowISO));
      if (!activeRows.length) {
        $("#reservationsWrap").innerHTML = '<div class="empty">Δεν υπάρχουν ενεργές κρατήσεις.</div>';
      } else {
        $("#reservationsWrap").innerHTML = `
          <table id="tblRes">
            <thead><tr><th>Ημερομηνία</th><th>Ποσό</th><th>Κατάσταση</th><th>Λήξη</th></tr></thead>
            <tbody></tbody></table>`;
        const body = document.querySelector("#tblRes tbody");
        activeRows.forEach(r=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${fmtDate(r.created_at)}</td>
            <td>${Number(r.credits_reserved ?? r.amount ?? 0)}</td>
            <td><span class="pill ok">active</span></td>
            <td>${r.expires_at ? fmtDate(r.expires_at) : '—'}</td>`;
          body.appendChild(tr);
        });
      }

      // Questions
      const qBody = $("#tblQuestions tbody"); qBody.innerHTML = "";
      let questions = [];
      try {
        questions = await safeSelect('app.questions','id,created_at,subject,status,credits_spent',{ match:{ user_id:user.id }, orderCol:'created_at', asc:false, limit:100 });
      } catch(e) {
        try {
          questions = await safeSelect('questions','id,created_at,subject,status,credits_spent',{ match:{ user_id:user.id }, orderCol:'created_at', asc:false, limit:100 });
        } catch(_){}
      }
      if (!questions.length) {
        $("#questionsWrap").innerHTML = '<div class="empty">Δεν υπάρχουν ερωτήσεις ακόμα.</div>';
      } else {
        questions.forEach(q=>{
          const pillClass = q.status==='answered' ? 'ok' : (q.status==='pending' ? 'warn' : 'mute');
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${fmtDate(q.created_at)}</td>
            <td>${safe(q.subject)}</td>
            <td><span class="pill ${pillClass}">${safe(q.status)}</span></td>
            <td>${Number(q.credits_spent ?? 0)}</td>`;
          qBody.appendChild(tr);
        });
      }

      // Answers
      const aBody = $("#tblAnswers tbody"); aBody.innerHTML = "";
      let answers = [];
      try {
        answers = await safeSelect('app.answers','id,created_at,subject,status,url,user_id',{ match:{ user_id:user.id }, orderCol:'created_at', asc:false, limit:100 });
      } catch(e) {
        try {
          answers = await safeSelect('answers','id,created_at,subject,status,url,user_id',{ match:{ user_id:user.id }, orderCol:'created_at', asc:false, limit:100 });
        } catch(_){}
      }
      if (!answers.length) {
        $("#answersWrap").innerHTML = '<div class="empty">Δεν υπάρχουν απαντήσεις ακόμα.</div>';
      } else {
        answers.forEach(a=>{
          const pillClass = (a.status==='sent'||a.status==='final') ? 'ok' : (a.status==='draft' ? 'warn' : 'mute');
          const link = a.url ? `<a class="link" href="${a.url}" target="_blank" rel="noopener">Άνοιγμα</a>` : '—';
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${fmtDate(a.created_at)}</td>
            <td>${safe(a.subject)}</td>
            <td><span class="pill ${pillClass}">${safe(a.status)}</span></td>
            <td>${link}</td>`;
          aBody.appendChild(tr);
        });
      }

    } catch(err) {
      console.error(err);
      alert("Κάτι πήγε στραβά στο φόρτωμα. Δες το console για λεπτομέρειες.");
    } finally {
      setSpin(false);
    }
  }

  // ========= 4) EVENTS =========
  $("#btnRefresh").addEventListener("click", loadAll);
  $("#btnLogout").addEventListener("click", async ()=>{
    await sb.auth.signOut();
    location.href = "/login.html";
  });

  // ========= 5) START =========
  loadAll();
</script>
</body>
</html>
