<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ProblemSolver • Μέλη</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--brand:#FF6B00;--muted:#6b7280;--ok:#16a34a;--bg:#f6f7f9}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:#111}
    header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:#fff;border-bottom:1px solid #eee;position:sticky;top:0;z-index:10}
    header .brand{display:flex;align-items:center;gap:12px;font-weight:700}
    header .brand img{width:32px;height:32px;border-radius:8px}
    header .actions{display:flex;gap:8px}
    .btn{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:600}
    .btn:hover{background:#fafafa}
    .container{max-width:1100px;margin:18px auto;padding:0 14px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .card{background:#fff;border:1px solid #eee;border-radius:14px;padding:14px}
    .kpi{padding:16px}
    .kpi h4{margin:0 0 8px 0;font-size:14px;color:var(--muted);font-weight:600}
    .kpi .value{min-height:28px;font-size:22px;font-weight:700;letter-spacing:0.2px}
    .section-title{font-weight:700;margin:6px 0 12px 0;color:#111}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid #eee;font-size:14px}
    th{color:#374151;text-align:left}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#f3f4f6;color:#374151;font-size:12px;font-weight:600}
    .pill.ok{background:#e8f7ec;color:#067647}
    .pill.warn{background:#fff4e5;color:#92400e}
    /* account */
    .account{display:grid;grid-template-columns:120px 1fr;row-gap:8px;column-gap:8px}
    .account .label{color:#6b7280}
    .account-section{margin-top:14px;padding-top:10px;border-top:2px solid rgba(255,107,0,.25)}
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>
<body>
  <header>
    <div class="brand">
      <img src="https://raw.githubusercontent.com/dkouretas-problemsolver/members-portal/main/public/brandmark-design-1080x1080.png" alt="ProblemSolver">
      ProblemSolver • Μέλη
    </div>
    <div class="actions">
      <button id="btnRefresh" class="btn">Ανανέωση</button>
      <button id="btnSignOut" class="btn">Αποσύνδεση</button>
    </div>
  </header>

  <div class="container">
    <div class="grid">
      <!-- KPIs -->
      <div class="card kpi" style="grid-column: span 3;">
        <h4>Σύνολο Credits</h4><div id="totalCredits" class="value">—</div>
      </div>
      <div class="card kpi" style="grid-column: span 3;">
        <h4>Δεσμευμένα</h4><div id="reservedCredits" class="value">—</div>
      </div>
      <div class="card kpi" style="grid-column: span 3;">
        <h4>Διαθέσιμα</h4><div id="availableCredits" class="value">—</div>
      </div>
      <div class="card kpi" style="grid-column: span 3;">
        <h4>Επόμενη Λήξη</h4><div id="nextExpiry" class="value">—</div>
      </div>

      <!-- Ιστορικό Ερωτήσεων -->
      <div class="card" style="grid-column: span 7;">
        <div class="section-title">Ιστορικό Ερωτήσεων</div>
        <table id="tblQuestions">
          <thead><tr><th>Ημερομηνία</th><th>Θέμα/Ερώτηση</th><th>Status</th></tr></thead>
          <tbody id="tbodyQuestions"><tr><td class="muted" colspan="3">—</td></tr></tbody>
        </table>
      </div>

      <!-- Λογαριασμός + Στοιχεία Πελάτη -->
      <div class="card" style="grid-column: span 5;">
        <div class="section-title">Λογαριασμός</div>
        <div class="account">
          <div class="label">Όνομα:</div> <div id="accName">—</div>
          <div class="label">Email:</div> <div id="accEmail" class="mono">—</div>
          <div class="label">User:</div>  <div id="accUser" class="mono">—</div>
        </div>

        <div class="account-section">
          <div class="section-title" style="margin:0 0 8px">Στοιχεία Πελάτη</div>
          <div class="account">
            <div class="label">Τύπος:</div>         <div id="billDocType">—</div>
            <div class="label">ΑΦΜ:</div>           <div id="billVat" class="mono">—</div>
            <div class="label">ΔΟΥ:</div>           <div id="billTaxOffice">—</div>
            <div class="label">Διεύθυνση:</div>     <div id="billAddress">—</div>
            <div class="label">Πόλη:</div>          <div id="billCity">—</div>
            <div class="label">Τ.Κ.:</div>          <div id="billZip">—</div>
            <div class="label">Χώρα:</div>          <div id="billCountry">—</div>
            <div class="label">Τηλέφωνο:</div>      <div id="billPhone">—</div>
            <div class="label">Email τιμολ.:</div>  <div id="billEmail" class="mono">—</div>
          </div>
        </div>

        <div class="section-title" style="margin-top:14px;">Κρατήσεις (Active)</div>
        <table id="tblRes">
          <!-- ΑΦΑΙΡΕΘΗΚΕ η στήλη Link -->
          <thead><tr><th>Ημερομηνία</th><th>Ποσό</th><th>Κατάσταση</th><th>Λήξη</th></tr></thead>
          <tbody id="tbodyRes"><tr><td class="muted" colspan="4">—</td></tr></tbody>
        </table>
      </div>

      <!-- Απαντήσεις (ΧΩΡΙΣ Link) -->
      <div class="card" style="grid-column: span 12;">
        <div class="section-title">Απαντήσεις</div>
        <table id="tblAnswers">
          <thead><tr><th>Ημερομηνία</th><th>Απάντηση / Πρόχειρο</th><th>Status</th></tr></thead>
          <tbody id="tbodyAnswers"><tr><td class="muted" colspan="3">—</td></tr></tbody>
        </table>
      </div>
    </div>

    <p class="muted" style="margin:18px 4px;">© ProblemSolver.gr</p>
  </div>

  <script>
    // === CONFIG (ίδιο με το αρχικό σου) ===
    const SUPABASE_URL = 'https://sctqieecpfsaszcuqcrv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjdHFpZWVjcGZzYXN6Y3VxY3J2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxODI5MjYsImV4cCI6MjA3NDc1ODkyNn0.swR5_WutqIlCvpH4s-2LEYgrH-UAp0op2sfKQeVWQOk';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{persistSession:true}, db:{schema:'app'} });

    const $ = sel => document.querySelector(sel);
    const fmt = iso => { if(!iso) return '—'; const d=new Date(iso); return isNaN(d)?'—':d.toLocaleString('el-GR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}); };

    async function requireUser(){
      const { data:{ user }, error } = await supabase.auth.getUser();
      if(error){ console.error(error); return null; }
      if(!user){ location.href='/login.html'; return null; }
      return user;
    }

    /* KPIs (όπως είχες) */
    async function loadBalances(){
      let total=0,reserved=0,nextExpiry=null;
      try{
        const { data, error } = await supabase.from('credit_balances').select('balance').maybeSingle();
        if(error) throw error; total = (data?.balance ?? 0)|0;
      }catch(e){ console.error('credit_balances', e); }
      try{
        const { data, error } = await supabase.from('credit_reservations').select('amount,credits_reserved,status,expires_at,created_at').eq('status','active');
        if(error) throw error;
        const now=new Date(); const active=(data||[]).filter(r=>r.status==='active' && (!r.expires_at || new Date(r.expires_at)>now));
        reserved = active.reduce((s,r)=>s+((r.credits_reserved ?? r.amount ?? 0)|0),0);
        active.forEach(r=>{ if(r.expires_at){ const d=new Date(r.expires_at); if(!nextExpiry||d<nextExpiry) nextExpiry=d; } });
      }catch(e){ console.warn('credit_reservations', e); }
      $('#totalCredits').textContent = total;
      $('#reservedCredits').textContent = reserved;
      $('#availableCredits').textContent = Math.max(0,total-reserved);
      $('#nextExpiry').textContent = nextExpiry ? nextExpiry.toLocaleDateString('el-GR') : '—';
    }

    /* Q&A */
    async function fetchMyQaAnswers(user){
      const { data, error } = await supabase.from('qa_answers')
        .select('id,created_at,updated_at,email,status,question,answer,agent_draft,user_id')
        .order('created_at',{ascending:false}).limit(200);
      if(error) throw error;
      return (data||[]).filter(r => (r.user_id && r.user_id===user.id) || (r.email && r.email===user.email));
    }
    async function loadQuestions(user){
      try{
        const rows = await fetchMyQaAnswers(user);
        const list = rows.filter(r => r.question && r.question.trim().length);
        const tb = $('#tbodyQuestions'); tb.innerHTML='';
        if(!list.length){ tb.innerHTML='<tr><td class="muted" colspan="3">—</td></tr>'; return; }
        for(const q of list){
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${fmt(q.created_at)}</td><td>${q.question}</td><td><span class="pill">${q.status||'—'}</span></td>`;
          tb.appendChild(tr);
        }
      }catch(e){ console.error('loadQuestions',e); $('#tbodyQuestions').innerHTML='<tr><td class="muted" colspan="3">—</td></tr>'; }
    }
    async function loadAnswers(user){
      try{
        const rows = await fetchMyQaAnswers(user);
        const list = rows.filter(r => (r.answer && r.answer.trim().length) || (r.agent_draft && r.agent_draft.trim().length));
        const tb = $('#tbodyAnswers'); tb.innerHTML='';
        if(!list.length){ tb.innerHTML='<tr><td class="muted" colspan="3">—</td></tr>'; return; }
        for(const a of list){
          const txt = (a.answer && a.answer.trim().length)?a.answer:(a.agent_draft||'—');
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${fmt(a.updated_at||a.created_at)}</td><td>${txt}</td><td><span class="pill">${a.status||'—'}</span></td>`;
          tb.appendChild(tr);
        }
      }catch(e){ console.error('loadAnswers',e); $('#tbodyAnswers').innerHTML='<tr><td class="muted" colspan="3">—</td></tr>'; }
    }

    /* Reservations (ΧΩΡΙΣ Link) */
    async function loadReservations(){
      try{
        const { data, error } = await supabase.from('credit_reservations')
          .select('amount,credits_reserved,status,created_at,expires_at').eq('status','active')
          .order('created_at',{ascending:false}).limit(50);
        if(error) throw error;
        const tb=$('#tbodyRes'); tb.innerHTML='';
        if(!data?.length){ tb.innerHTML='<tr><td class="muted" colspan="4">—</td></tr>'; return; }
        for(const r of data){
          const amt=(r.credits_reserved ?? r.amount ?? 0);
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${fmt(r.created_at)}</td><td>${amt}</td><td><span class="pill ${r.status==='active'?'ok':'warn'}">${r.status}</span></td><td>${r.expires_at?fmt(r.expires_at):'—'}</td>`;
          tb.appendChild(tr);
        }
      }catch(e){ console.warn('loadReservations',e); $('#tbodyRes').innerHTML='<tr><td class="muted" colspan="4">—</td></tr>'; }
    }

    /* Account + BILLING INFO από app.user_billing */
    async function loadAccountBlock(user){
      $('#accEmail').textContent = user.email || '—';
      $('#accUser').textContent  = user.id || '—';
      $('#accName').textContent  = user.user_metadata?.name || '—';

      try{
        const { data, error } = await supabase.from('user_billing')
          .select('doc_type,vat,tax_office,address,city,zip,country,phone,email')
          .eq('user_id', user.id).maybeSingle();
        if(error) throw error;
        const v = data || {};
        $('#billDocType').textContent = v.doc_type==='invoice'?'Τιμολόγιο':'Απόδειξη';
        $('#billVat').textContent = v.vat || '—';
        $('#billTaxOffice').textContent = v.tax_office || '—';
        $('#billAddress').textContent = v.address || '—';
        $('#billCity').textContent = v.city || '—';
        $('#billZip').textContent = v.zip || '—';
        $('#billCountry').textContent = v.country || '—';
        $('#billPhone').textContent = v.phone || '—';
        $('#billEmail').textContent = v.email || user.email || '—';
      }catch(e){
        console.warn('user_billing', e);
      }
    }

    async function boot(){
      const user = await requireUser(); if(!user) return;
      await loadAccountBlock(user);
      await loadBalances();
      await loadQuestions(user);
      await loadAnswers(user);
      await loadReservations();
    }

    document.getElementById('btnRefresh').addEventListener('click', boot);
    document.getElementById('btnSignOut').addEventListener('click', async ()=>{ await supabase.auth.signOut(); location.href='/login.html'; });

    boot();
  </script>
</body>
</html>
