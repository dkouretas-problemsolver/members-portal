<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ProblemSolver • Μέλη</title>
  <link rel="icon" href="/brandmark-design-1080x1080.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--brand:#FF6B00;--muted:#6b7280;--ok:#16a34a;--bg:#f6f7f9}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:#111}
    header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:#fff;border-bottom:1px solid #eee;position:sticky;top:0;z-index:10}
    header .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    header .brand .dot{width:10px;height:10px;background:var(--brand);border-radius:50%}
    header .actions{display:flex;gap:8px}
    .btn{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:600}
    .btn:hover{background:#fafafa}
    .container{max-width:1100px;margin:18px auto;padding:0 14px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .card{background:#fff;border:1px solid #eee;border-radius:14px;padding:14px}
    .kpi{padding:16px}
    .kpi h4{margin:0 0 8px 0;font-size:14px;color:var(--muted);font-weight:600}
    .kpi .value{min-height:28px;font-size:22px;font-weight:700;letter-spacing:0.2px}
    .section-title{font-weight:700;margin:6px 0 12px 0}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid #eee;font-size:14px}
    th{color:#374151;text-align:left}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#f3f4f6;color:#374151;font-size:12px;font-weight:600}
    .pill.ok{background:#e8f7ec;color:#067647}
    .pill.warn{background:#fff4e5;color:#92400e}
    .right{display:flex;justify-content:flex-end;gap:8px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace}
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>
<body>
  <header>
    <div class="brand">
      <span class="dot"></span>
      ProblemSolver • Μέλη
    </div>
    <div class="actions">
      <button id="btnRefresh" class="btn">Ανανέωση</button>
      <button id="btnSignOut" class="btn">Αποσύνδεση</button>
    </div>
  </header>

  <div class="container">
    <div class="grid">
      <!-- KPIs (CREDITS) — δεν πειράχτηκαν -->
      <div class="card kpi" style="grid-column: span 3;">
        <h4>Σύνολο Credits</h4><div id="totalCredits" class="value">—</div>
      </div>
      <div class="card kpi" style="grid-column: span 3;">
        <h4>Δεσμευμένα</h4><div id="reservedCredits" class="value">—</div>
      </div>
      <div class="card kpi" style="grid-column: span 3;">
        <h4>Διαθέσιμα</h4><div id="availableCredits" class="value">—</div>
      </div>
      <div class="card kpi" style="grid-column: span 3;">
        <h4>Επόμενη Λήξη</h4><div id="nextExpiry" class="value">—</div>
      </div>

      <!-- Ιστορικό Ερωτήσεων (από qa_answers.question) -->
      <div class="card" style="grid-column: span 7;">
        <div class="section-title">Ιστορικό Ερωτήσεων</div>
        <table id="tblQuestions">
          <thead>
            <tr><th>Ημερομηνία</th><th>Θέμα/Ερώτηση</th><th>Status</th></tr>
          </thead>
          <tbody id="tbodyQuestions">
            <tr><td class="muted" colspan="3">—</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Κάρτα Λογαριασμού -->
      <div class="card" style="grid-column: span 5;">
        <div class="section-title">Λογαριασμός</div>
        <div style="display:grid;grid-template-columns:120px 1fr;row-gap:8px">
          <div class="muted">Όνομα:</div><div id="accName">—</div>
          <div class="muted">Email:</div><div id="accEmail" class="mono">—</div>
          <div class="muted">User:</div><div id="accUser" class="mono">—</div>
          <div class="muted">ID:</div><div id="accInstance" class="mono">—</div>
        </div>

        <div class="section-title" style="margin-top:14px;">Κρατήσεις (Active)</div>
        <table id="tblRes">
          <thead>
            <tr><th>Ημερομηνία</th><th>Ποσό</th><th>Κατάσταση</th><th>Λήξη</th><th class="right">Link</th></tr>
          </thead>
          <tbody id="tbodyRes">
            <tr><td class="muted" colspan="5">—</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Απαντήσεις (από qa_answers.answer/agent_draft) -->
      <div class="card" style="grid-column: span 12;">
        <div class="section-title">Απαντήσεις</div>
        <table id="tblAnswers">
          <thead>
            <tr><th>Ημερομηνία</th><th>Απάντηση / Πρόχειρο</th><th>Status</th><th class="right">Link</th></tr>
          </thead>
          <tbody id="tbodyAnswers">
            <tr><td class="muted" colspan="4">—</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <p class="muted" style="margin:18px 4px;">© ProblemSolver.gr • Αν κάτι δεν φορτώνει, πάτα «Ανανέωση» ή κάνε νέα είσοδο.</p>
  </div>

  <script>
    // === CONFIG ===
    const SUPABASE_URL = 'https://sctqieecpfsaszcuqcrv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjdHFpZWVjcGZzYXN6Y3VxY3J2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxODI5MjYsImV4cCI6MjA3NDc1ODkyNn0.swR5_WutqIlCvpH4s-2LEYgrH-UAp0op2sfKQeVWQOk';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true },
      db: { schema: 'app' }
    });

    // === Helpers ===
    const el = (sel) => document.querySelector(sel);
    const fmtDate = (iso) => {
      if (!iso) return '—';
      const d = new Date(iso);
      return isNaN(d) ? '—' : d.toLocaleString('el-GR', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
    };

    // ===== AUTH / ACCOUNT =====
    async function requireUser() {
      const { data: { user }, error } = await supabase.auth.getUser();
      if (error) { console.error(error); return null; }
      if (!user) { window.location.href = '/login.html'; return null; }
      return user;
    }
    async function loadAccount(user) {
      el('#accEmail').textContent = user.email || '—';
      el('#accUser').textContent  = user.id || '—';
      el('#accName').textContent  = '—';
      el('#accInstance').textContent = '—';
    }

    // ===== CREDITS (όπως δούλευαν) =====
    async function loadBalances() {
      let total = 0, reserved = 0, nextExpiry = null;

      try {
        const { data, error } = await supabase.from('credit_balances').select('balance').maybeSingle();
        if (error) throw error;
        total = (data?.balance ?? 0) | 0;
      } catch (e) { console.error('credit_balances:', e); }

      try {
        const { data, error } = await supabase
          .from('credit_reservations')
          .select('amount, credits_reserved, status, expires_at, created_at')
          .eq('status', 'active');
        if (error) throw error;

        const now = new Date();
        const active = (data || []).filter(r => r.status === 'active' && (!r.expires_at || new Date(r.expires_at) > now));
        reserved = active.reduce((s,r)=> s + ((r.credits_reserved ?? r.amount ?? 0)|0), 0);
        active.forEach(r => { if (r.expires_at) { const d = new Date(r.expires_at); if (!nextExpiry || d < nextExpiry) nextExpiry = d; }});
      } catch (e) { console.warn('credit_reservations:', e.message || e); }

      el('#totalCredits').textContent = total;
      el('#reservedCredits').textContent = reserved;
      el('#availableCredits').textContent = Math.max(0, total - reserved);
      el('#nextExpiry').textContent = nextExpiry ? nextExpiry.toLocaleDateString('el-GR') : '—';
    }

    // ===== Q&A από app.qa_answers =====
    async function fetchMyQaAnswers(user) {
      // παίρνουμε * όλα τα βασικά πεδία
      const { data, error } = await supabase
        .from('qa_answers')
        .select('id, created_at, updated_at, email, status, question, answer, agent_draft, user_id')
        .order('created_at', { ascending: false })
        .limit(200);

      if (error) throw error;

      // client-side φίλτρο: είτε user_id = auth.uid() είτε email = user.email
      const mine = (data || []).filter(r =>
        (r.user_id && r.user_id === user.id) || (r.email && r.email === user.email)
      );
      return mine;
    }

    async function loadQuestions(user) {
      try {
        const rows = await fetchMyQaAnswers(user);
        const questions = rows.filter(r => !!(r.question && r.question.trim().length));

        const tbody = el('#tbodyQuestions');
        tbody.innerHTML = '';
        if (!questions.length) {
          tbody.innerHTML = '<tr><td class="muted" colspan="3">—</td></tr>';
          return;
        }

        for (const q of questions) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${fmtDate(q.created_at)}</td>
            <td>${q.question}</td>
            <td><span class="pill">${q.status || '—'}</span></td>
          `;
          tbody.appendChild(tr);
        }
      } catch (e) {
        console.error('loadQuestions:', e.message || e);
        el('#tbodyQuestions').innerHTML = '<tr><td class="muted" colspan="3">—</td></tr>';
      }
    }

    async function loadAnswers(user) {
      try {
        const rows = await fetchMyQaAnswers(user);
        // δείξε answer, αλλιώς agent_draft (ό,τι υπάρχει)
        const answers = rows.filter(r => (r.answer && r.answer.trim().length) || (r.agent_draft && r.agent_draft.trim().length));

        const tbody = el('#tbodyAnswers');
        tbody.innerHTML = '';
        if (!answers.length) {
          tbody.innerHTML = '<tr><td class="muted" colspan="4">—</td></tr>';
          return;
        }

        for (const a of answers) {
          const text = (a.answer && a.answer.trim().length) ? a.answer : (a.agent_draft || '—');
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${fmtDate(a.updated_at || a.created_at)}</td>
            <td>${text}</td>
            <td><span class="pill">${a.status || '—'}</span></td>
            <td class="right">—</td>
          `;
          tbody.appendChild(tr);
        }
      } catch (e) {
        console.error('loadAnswers:', e.message || e);
        el('#tbodyAnswers').innerHTML = '<tr><td class="muted" colspan="4">—</td></tr>';
      }
    }

    // ===== Reservations table (όπως ήταν) =====
    async function loadReservations() {
      try {
        const { data, error } = await supabase
          .from('credit_reservations')
          .select('id, amount, credits_reserved, status, created_at, expires_at, question_id')
          .eq('status', 'active')
          .order('created_at', { ascending: false })
          .limit(50);
        if (error) throw error;

        const tbody = document.querySelector('#tbodyRes');
        tbody.innerHTML = '';
        if (!data?.length) {
          tbody.innerHTML = '<tr><td class="muted" colspan="5">Καμία ενεργή κράτηση.</td></tr>';
          return;
        }
        for (const r of data) {
          const amt = (r.credits_reserved ?? r.amount ?? 0);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${fmtDate(r.created_at)}</td>
            <td>${amt}</td>
            <td><span class="pill ${r.status==='active'?'ok':'warn'}">${r.status}</span></td>
            <td>${r.expires_at ? fmtDate(r.expires_at) : '—'}</td>
            <td class="right"><a class="mono" href="/questions/${r.question_id||''}" target="_blank">άνοιγμα</a></td>
          `;
          tbody.appendChild(tr);
        }
      } catch (e) {
        console.warn('loadReservations:', e.message || e);
        document.querySelector('#tbodyRes').innerHTML =
          '<tr><td class="muted" colspan="5">—</td></tr>';
      }
    }

    // ===== Boot =====
    async function boot() {
      const user = await requireUser();
      if (!user) return;

      // Λογαριασμός
      await loadAccount(user);

      // Credits (όπως δούλευαν)
      await loadBalances();

      // Q&A από qa_answers (σύμφωνα με τις στήλες σου)
      await loadQuestions(user);
      await loadAnswers(user);

      // Reservations (αν θες να το κρύψω, πες μου)
      await loadReservations();
    }

    document.getElementById('btnRefresh').addEventListener('click', boot);
    document.getElementById('btnSignOut').addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = '/login.html';
    });

    boot();
  </script>
</body>
</html>
