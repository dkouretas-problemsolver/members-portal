<!doctype html>
<html lang="el">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ProblemSolver — Members</title>
<link rel="icon" href="/favicon.ico" />
<style>
  :root{
    --bg:#fafafa; --fg:#111; --muted:#666; --link:#2563eb; --ok:#16a34a; --err:#dc2626;
    --card:#fff; --border:#e5e7eb; --btn:#f97316; --btn-fg:#fff; --btn-disabled:#f1f5f9;
  }
  html,body{height:100%;}
  body{
    margin:0; background:var(--bg); color:var(--fg); font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    display:flex; align-items:center; justify-content:center; padding:24px;
  }
  .container{width:100%; max-width:840px; background:var(--card); border:1px solid var(--border); border-radius:12px; padding:28px 28px 32px;}
  .logo{display:block; margin:0 auto 16px auto; height:32px;}
  h1{margin:0 0 20px; text-align:center; font-size:24px;}
  .google-btn{
    display:flex; gap:10px; align-items:center; justify-content:center;
    border:1px solid var(--border); border-radius:10px; padding:10px 14px; cursor:pointer;
    width:fit-content; margin:0 auto 24px; background:#fff;
  }
  .grid{display:grid; gap:28px; grid-template-columns: 1fr 1fr;}
  @media (max-width:760px){ .grid{grid-template-columns:1fr;} }
  .card{border:1px solid var(--border); border-radius:12px; padding:18px;}
  .card h2{margin:0 0 8px; font-size:16px;}
  .field{display:flex; flex-direction:column; gap:6px; margin:12px 0;}
  .field label{font-size:13px; color:var(--muted);}
  .field input{
    border:1px solid var(--border); border-radius:8px; padding:10px 12px; outline:none;
    font-size:15px;
  }
  .hint{font-size:12px; color:var(--muted); margin-top:6px;}
  .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
  .btn{
    appearance:none; border:0; background:var(--btn); color:var(--btn-fg);
    padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer;
  }
  .btn.secondary{background:#f3f4f6; color:#111;}
  .btn.link{background:transparent; color:var(--link); padding:0;}
  .disabled-btn{background:var(--btn-disabled) !important; color:#9aa4b2 !important; cursor:not-allowed;}
  .msg{font-size:14px; padding:8px 10px; border-radius:8px; margin-top:10px; border:1px solid var(--border); display:none;}
  .msg.ok{background:#f0fdf4; color:#14532d; border-color:#86efac;}
  .msg.err{background:#fef2f2; color:#7f1d1d; border-color:#fecaca;}
  .center{display:flex; justify-content:center; gap:8px; align-items:center;}
  .link{color:var(--link); text-decoration:none;}
  /* Forgot & recovery */
  .panel{display:none; border:1px solid var(--border); border-radius:12px; padding:18px; margin-top:18px;}
  .panel h3{margin:0 0 8px; font-size:16px;}
</style>
</head>
<body>
  <div class="container">
    <img class="logo" src="ProblemSolver.gr.png" alt="ProblemSolver logo" />
    <h1>ProblemSolver — Members</h1>

    <div class="google-btn" id="googleBtn" role="button" aria-label="Σύνδεση με Google">
      <!-- μικρό G εικονίδιο -->
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,16.108,18.961,13,24,13c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.51,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.094,5.571l0.003-0.002l6.19,5.238C36.807,40.205,44,36,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
      <span>Σύνδεση με Google</span>
    </div>

    <div id="globalMsg" class="msg err"></div>

    <div id="authGrid" class="grid">
      <!-- Αριστερό: Email + Κωδικός -->
      <div class="card">
        <h2>Σύνδεση με Κωδικό</h2>
        <div class="field">
          <label for="emailInput">Email</label>
          <input id="emailInput" type="email" placeholder="you@example.com" autocomplete="username" />
        </div>
        <div class="field">
          <label for="passwordInput">Κωδικός</label>
          <input id="passwordInput" type="password" placeholder="********" autocomplete="current-password" />
          <div class="hint">Απαραίτητο: ≥ 8 χαρακτήρες, 1 κεφαλαίο, 1 πεζό, 1 ψηφίο &amp; 1 σύμβολο.</div>
        </div>

        <div id="leftMsg" class="msg"></div>

        <div class="row">
          <button id="signinBtn" class="btn">Σύνδεση</button>
          <button id="signupBtn" class="btn secondary">Δημιουργία Λογαριασμού</button>
        </div>

        <div class="row">
          <a id="forgotLink" class="link" href="#">Ξέχασα τον κωδικό</a>
        </div>
      </div>

      <!-- Δεξί: Magic Link -->
      <div class="card">
        <h2>Σύνδεση με Magic Link</h2>
        <div class="field">
          <label for="magicEmailInput">Email</label>
          <input id="magicEmailInput" type="email" placeholder="you@example.com" />
        </div>

        <div id="rightMsg" class="msg"></div>

        <div class="row">
          <button id="magicBtn" class="btn">Στείλε μου Magic Link</button>
        </div>
      </div>
    </div>

    <!-- Forgot panel -->
    <div id="forgotPanel" class="panel">
      <div class="center" style="justify-content:space-between;">
        <h3 style="margin:0;">Ξέχασα τον κωδικό</h3>
        <button id="forgotCloseBtn" class="btn secondary">Κλείσιμο</button>
      </div>
      <div class="field" style="margin-top:12px;">
        <label for="forgotEmailInput">Email</label>
        <input id="forgotEmailInput" type="email" placeholder="you@example.com" />
      </div>
      <div id="forgotMsg" class="msg"></div>
      <button id="forgotBtn" class="btn">Στείλε email επαναφοράς</button>
    </div>

    <!-- Recovery box -->
    <div id="recoveryBox" class="panel">
      <h3>Αλλαγή κωδικού</h3>
      <div class="field">
        <label for="newPass1">Νέος κωδικός</label>
        <input id="newPass1" type="password" />
      </div>
      <div class="field">
        <label for="newPass2">Ξανά ο νέος κωδικός</label>
        <input id="newPass2" type="password" />
      </div>
      <div id="recoveryMsg" class="msg"></div>
      <button id="setNewPassBtn" class="btn">Αποθήκευση</button>
    </div>
  </div>

<script type="module">
  // ===== helpers =====
  const $ = (id)=>document.getElementById(id);
  const showMsg = (el, text, ok=false)=>{
    el.className = 'msg ' + (ok ? 'ok' : 'err');
    el.textContent = text;
    el.style.display = 'block';
  };
  const hideMsg = (el)=>{ el.style.display='none'; };

  const leftMsg = $('leftMsg'), rightMsg = $('rightMsg'), globalMsg = $('globalMsg');

  // ===== Supabase client =====
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
  const sb = createClient(
    'https://problemsolver-members.supabase.co',  // <-- βάλε το δικό σου project URL αν είναι άλλο
    'public-anon-key'                              // <-- public anon key
  );

  const goDashboard = ()=> location.href = '/dashboard.html';

  // ===== Auth flows =====
  $('signinBtn').onclick = async ()=>{
    hideMsg(leftMsg);
    const email = $('emailInput').value.trim();
    const password = $('passwordInput').value;
    const { error } = await sb.auth.signInWithPassword({ email, password });
    if (error) return showMsg(leftMsg,error.message);
    if (!location.hash.includes('type=recovery')) goDashboard();
  };

  // ------- ΜΟΝΗ ΑΛΛΑΓΗ: pre-check αν υπάρχει ήδη email --------
  $('signupBtn').onclick = async ()=>{
    hideMsg(leftMsg);
    const email = $('emailInput').value.trim();
    const password = $('passwordInput').value;

    // Προ-έλεγχος: υπάρχει ήδη λογαριασμός με αυτό το email;
    try {
      const { data: existing, error: qerr } = await sb
        .from('user_emails')
        .select('email')
        .eq('email', email)
        .maybeSingle();

      if (!qerr && existing) {
        return showMsg(leftMsg, 'Ο χρήστης υπάρχει ήδη.', false);
      }
    } catch (_) { /* αν αποτύχει ο έλεγχος, συνεχίζουμε κανονικά */ }

    const { error } = await sb.auth.signUp({
      email, password,
      options: { emailRedirectTo: location.origin + '/' }
    });
    if (error) return showMsg(leftMsg,error.message);
    showMsg(leftMsg,'Σου στείλαμε email επιβεβαίωσης.',true);
  };
  // -------------------------------------------------------------

  $('magicBtn').onclick = async ()=>{
    hideMsg(rightMsg);
    const email = $('magicEmailInput').value.trim();
    const { error } = await sb.auth.signInWithOtp({
      email,
      options: { emailRedirectTo: location.origin + '/' }
    });
    if (error) return showMsg(rightMsg,error.message);
    showMsg(rightMsg,'Σου στείλαμε σύνδεσμο στο email.',true);
  };

  $('googleBtn').onclick = ()=> sb.auth.signInWithOAuth({
    provider:'google', options:{ redirectTo: location.origin + '/' }
  });

  // Forgot password
  $('forgotLink').onclick = (e)=>{
    e.preventDefault();
    $('forgotPanel').style.display='block';
    $('forgotEmailInput').value = $('emailInput').value || '';
  };
  $('forgotCloseBtn').onclick = ()=>{ $('forgotPanel').style.display='none'; hideMsg($('forgotMsg')); };
  $('forgotBtn').onclick = async ()=>{
    hideMsg($('forgotMsg'));
    const email = $('forgotEmailInput').value.trim();
    const { error } = await sb.auth.resetPasswordForEmail(email, {
      redirectTo: location.origin + location.pathname
    });
    if (error) return showMsg($('forgotMsg'), error.message);
    showMsg($('forgotMsg'), 'Έλεγξε το email σου για οδηγίες επαναφοράς.', true);
  };

  function enterRecovery(){
    $('authGrid').style.display='none';
    $('forgotPanel').style.display='none';
    $('recoveryBox').style.display='block';
    hideMsg(globalMsg);
  }

  if (location.hash.includes('type=recovery')) enterRecovery();

  sb.auth.onAuthStateChange((event) => {
    if (event === 'PASSWORD_RECOVERY') enterRecovery();
  });

  $('setNewPassBtn').onclick = async () => {
    hideMsg($('recoveryMsg'));
    const p1 = $('newPass1').value, p2 = $('newPass2').value;
    if (!p1 || p1 !== p2) return showMsg($('recoveryMsg'),'Οι κωδικοί δεν ταιριάξαν.');
    const { error } = await sb.auth.updateUser({ password: p1 });
    if (error) return showMsg($('recoveryMsg'),'Σφάλμα: ' + error.message);
    showMsg($('recoveryMsg'),'Ο κωδικός άλλαξε. Μπαίνεις...', true);
    setTimeout(goDashboard, 600);
  };

  // Code exchange (OAuth/Magic/Confirm)
  (async ()=>{
    const q = new URLSearchParams(location.search);
    const code = q.get('code');
    if (code) {
      const { error } = await sb.auth.exchangeCodeForSession({ code });
      if (error) return showMsg(globalMsg,'Σφάλμα σύνδεσης. Δοκίμασε ξανά.');
      const u=new URL(location); ['code','state','type'].forEach(k=>u.searchParams.delete(k)); history.replaceState({},'',u);
      if (!location.hash.includes('type=recovery')) goDashboard();
    }
  })();

  // Προληπτικό enable/disable στο κουμπί «Σύνδεση»
  (()=>{
    const email = $('emailInput'), pass = $('passwordInput'), btn = $('signinBtn');
    const toggle = () => {
      const ok = email.checkValidity() && pass.value.length >= 6;
      btn.classList.toggle('disabled-btn', !ok);
      btn.disabled = !ok;
    };
    email.addEventListener('input', toggle);
    pass .addEventListener('input', toggle);
    toggle();
  })();
</script>
</body>
</html>
