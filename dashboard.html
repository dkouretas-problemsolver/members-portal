<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard – ProblemSolver Members</title>
  <style>
    body{font-family:Inter,Arial,sans-serif;margin:0;padding:24px;background:#fafafa}
    .wrap{max-width:880px;margin:0 auto}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .card{background:#fff;border:1px solid #eee;border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.05);padding:18px;margin-bottom:16px}
    h1{font-size:22px;margin:0}
    h2{font-size:16px;margin:0 0 8px}
    .muted{color:#666}
    .btn{border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn--ghost{background:#f3f4f6}
    .list{margin:0;padding:0;list-style:none}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;border-top:1px solid #f2f2f2;padding:10px 0}
    .chip{font-size:12px;background:#f3f4f6;border-radius:999px;padding:4px 8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ProblemSolver — Members</h1>
      <div>
        <button id="logout" class="btn btn--ghost">Αποσύνδεση</button>
      </div>
    </header>

    <div class="card">
      <h2>Καλωσήρθες, <span id="email" class="muted">...</span></h2>
      <div class="muted" id="uid"></div>
    </div>

    <div class="card">
      <h2>Υπόλοιπο Credits</h2>
      <div id="balance" style="font-size:28px;margin-top:6px;">—</div>
      <div class="muted" style="margin-top:6px;">(από Zoho → n8n → Supabase)</div>
    </div>

    <div class="card">
      <h2>Τελευταίες 5 Ερωτήσεις</h2>
      <ul id="questions" class="list"></ul>
      <div id="noq" class="muted">Δεν υπάρχουν ακόμα ερωτήσεις.</div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    // --- τα δικά σου στοιχεία ---
    const SUPABASE_URL = 'https://sctqieecpfsaszcuqcrv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjdHFpZWVjcGZzYXN6Y3VxY3J2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxODI5MjYsImV4cCI6MjA3NDc1ODkyNn0.swR5_WutqIlCvpH4s-2LEYgrH-UAp0op2sfKQeVWQOk';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true } });

    const emailEl = document.getElementById('email');
    const uidEl   = document.getElementById('uid');
    const balEl   = document.getElementById('balance');
    const qList   = document.getElementById('questions');
    const noqEl   = document.getElementById('noq');
    const logoutBtn = document.getElementById('logout');

    const guard = async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.user) {
        // αν δεν είναι logged in, ξαναστείλ' τον στην αρχική
        window.location.href = '/';
        return null;
      }
      emailEl.textContent = session.user.email || '—';
      uidEl.textContent   = 'User ID: ' + session.user.id;
      return session.user;
    };

    const loadBalance = async () => {
      const { data, error } = await supabase.rpc('app.get_my_balance');
      if (error) { balEl.textContent = 'Σφάλμα'; console.error(error); return; }
      balEl.textContent = data ?? 0;
    };

    const loadQuestions = async () => {
      // διαβάζουμε μόνο τα δικά μου, RLS τα φιλτράρει κιόλας
      const { data, error } = await supabase
        .from('app.questions')
        .select('id,title,status,created_at')
        .order('created_at', { ascending:false })
        .limit(5);

      if (error) { console.error(error); return; }
      qList.innerHTML = '';
      if (!data || data.length === 0) { noqEl.style.display='block'; return; }
      noqEl.style.display='none';
      for (const q of data) {
        const li = document.createElement('li');
        li.className = 'row';
        const left = document.createElement('div');
        left.innerHTML = `<div><strong>${q.title || '—'}</strong></div><div class="muted">${new Date(q.created_at).toLocaleString()}</div>`;
        const right = document.createElement('div');
        right.innerHTML = `<span class="chip">${q.status}</span>`;
        li.append(left, right);
        qList.append(li);
      }
    };

    logoutBtn.addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = '/';
    });

    const boot = async () => {
      const me = await guard(); if (!me) return;
      await loadBalance();
      await loadQuestions();
      supabase.auth.onAuthStateChange(async (_event, session) => {
        if (!session) window.location.href = '/';
      });
    };
    boot();
  </script>
</body>
</html>
